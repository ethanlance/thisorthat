# Story 5.1: Comments System

## Overview

Implement a comprehensive comments system that allows users to discuss and provide context for polls. This includes threaded comments, real-time updates, and proper moderation capabilities.

## User Stories

### As a poll voter
- I want to comment on polls to explain my choice or ask questions
- I want to see what others are saying about the poll options
- I want to reply to specific comments to have focused discussions
- I want to see new comments appear in real-time as they're posted

### As a poll creator
- I want to see all comments on my polls to understand community feedback
- I want to engage with voters through comments to provide additional context
- I want to moderate inappropriate comments on my polls

### As a platform user
- I want comments to help me make better decisions by seeing others' reasoning
- I want to build community around shared interests through discussion
- I want to report inappropriate comments when I see them

## Acceptance Criteria

### Core Commenting Functionality
1. **Comment Creation**
   - Users can add comments to any poll they can view
   - Comments have a 500 character limit with live character count
   - Comments support basic text formatting (line breaks, emojis)
   - Comments are timestamped and show author information

2. **Threaded Replies**
   - Users can reply to existing comments to create threaded discussions
   - Reply depth is limited to 2 levels (comment → reply → no further nesting)
   - Threaded replies are visually indented and grouped
   - Users can collapse/expand comment threads

3. **Real-time Updates**
   - New comments appear immediately without page refresh
   - Comment counts update in real-time
   - Users see typing indicators when others are composing comments
   - Connection status is shown for real-time features

4. **Comment Display**
   - Comments are sorted by creation time (newest first)
   - Each comment shows author name, avatar, timestamp, and content
   - Comments are paginated (20 per page) with "Load More" functionality
   - Long comments are truncated with "Show More" option

### User Experience
5. **Comment Interface**
   - Comment form is prominently displayed below poll results
   - Form includes character counter and submit button
   - Form validates input and shows helpful error messages
   - Form is disabled for closed polls with explanatory message

6. **Mobile Optimization**
   - Comment interface is touch-friendly with large tap targets
   - Text input is optimized for mobile keyboards
   - Comments are readable on small screens with proper spacing
   - Swipe gestures work for comment interactions

7. **Accessibility**
   - All comment elements have proper ARIA labels
   - Keyboard navigation works for all comment interactions
   - Screen readers can properly announce comment structure
   - High contrast mode is supported

### Moderation & Safety
8. **Content Moderation**
   - Comments are filtered for inappropriate content
   - Users can report comments for review
   - Poll creators can delete comments on their polls
   - Comment deletion is logged for audit purposes

9. **User Controls**
   - Users can edit their own comments within 5 minutes of posting
   - Users can delete their own comments
   - Users can block other users to hide their comments
   - Comment history is preserved for moderation purposes

## Technical Requirements

### Database Schema
- Implement `comments` table with proper relationships
- Add indexes for performance on poll_id and created_at
- Implement Row Level Security (RLS) policies
- Add foreign key constraints and cascading deletes

### API Endpoints
- `GET /api/polls/[id]/comments` - Fetch comments for a poll
- `POST /api/polls/[id]/comments` - Create new comment
- `PUT /api/comments/[id]` - Edit existing comment
- `DELETE /api/comments/[id]` - Delete comment
- `POST /api/comments/[id]/report` - Report inappropriate comment

### Real-time Features
- Supabase Realtime subscription for new comments
- Optimistic updates for better perceived performance
- Connection status management and reconnection logic
- Rate limiting to prevent comment spam

### Frontend Components
- `CommentSection` - Main container for all comment functionality
- `CommentList` - Displays paginated list of comments
- `CommentItem` - Individual comment with replies
- `CommentForm` - Form for creating new comments
- `CommentReply` - Form for replying to comments
- `CommentModeration` - Tools for poll creators to moderate

## Implementation Plan

### Phase 1: Core Infrastructure
1. **Database Setup**
   - Create comments table with proper schema
   - Implement RLS policies for security
   - Add database indexes for performance
   - Create database functions for comment operations

2. **API Development**
   - Implement comment CRUD endpoints
   - Add input validation and sanitization
   - Implement rate limiting and spam prevention
   - Add proper error handling and responses

3. **Basic Frontend**
   - Create comment display components
   - Implement comment creation form
   - Add basic styling and responsive design
   - Integrate with existing poll pages

### Phase 2: Advanced Features
4. **Real-time Updates**
   - Implement Supabase Realtime subscriptions
   - Add optimistic updates for better UX
   - Handle connection status and reconnection
   - Add typing indicators and live updates

5. **Threaded Replies**
   - Implement reply functionality
   - Add visual threading with proper indentation
   - Implement collapse/expand for long threads
   - Add proper navigation for threaded discussions

6. **User Experience**
   - Add comment pagination and infinite scroll
   - Implement comment editing and deletion
   - Add user blocking and moderation features
   - Optimize for mobile devices

### Phase 3: Moderation & Polish
7. **Content Moderation**
   - Implement content filtering system
   - Add user reporting functionality
   - Create moderation dashboard for poll creators
   - Add audit logging for moderation actions

8. **Performance & Accessibility**
   - Optimize database queries and caching
   - Add comprehensive accessibility features
   - Implement proper error boundaries
   - Add comprehensive testing coverage

## Testing Strategy

### Unit Tests
- Comment service functions and validation
- Comment component rendering and interactions
- Real-time subscription management
- Moderation and reporting functionality

### Integration Tests
- End-to-end comment creation and display
- Real-time comment updates across multiple users
- Comment moderation and user blocking
- Mobile responsiveness and touch interactions

### Performance Tests
- Comment loading performance with large datasets
- Real-time update latency and reliability
- Database query performance under load
- Memory usage with long comment threads

## Success Metrics

### User Engagement
- Average comments per poll
- Comment reply rate and thread depth
- Time spent reading comments
- User retention after commenting

### Technical Performance
- Comment load time < 500ms
- Real-time update latency < 200ms
- 99.9% uptime for comment system
- Zero data loss for comment operations

### Moderation Effectiveness
- Inappropriate comment detection rate
- User reporting accuracy
- Moderation response time
- User satisfaction with comment quality

## Dependencies

### External Services
- Supabase Realtime for live updates
- Content moderation API (future enhancement)
- Image processing for user avatars

### Internal Dependencies
- User authentication system (Story 1.3)
- Poll viewing interface (Story 3.1)
- User profile management (Story 5.4)
- Content moderation system (Story 5.2)

## Future Enhancements

### Advanced Features
- Comment reactions (like, dislike, helpful)
- Comment mentions and notifications
- Rich text formatting in comments
- Comment search and filtering

### Moderation Tools
- AI-powered content moderation
- Community moderation with user roles
- Comment quality scoring
- Automated spam detection

### Social Features
- Comment following and notifications
- Comment sharing and embedding
- Comment analytics and insights
- Integration with social media platforms

## Definition of Done

- [ ] Comments can be created, edited, and deleted
- [ ] Threaded replies work with proper visual hierarchy
- [ ] Real-time updates work reliably across devices
- [ ] Mobile interface is fully functional and responsive
- [ ] Content moderation and reporting systems work
- [ ] All accessibility requirements are met
- [ ] Performance targets are achieved
- [ ] Comprehensive test coverage is in place
- [ ] Documentation is complete and up-to-date
- [ ] Code review is completed and approved
