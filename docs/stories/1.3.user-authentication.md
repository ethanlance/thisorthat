# Story 1.3: User Authentication System

## Status
Draft

## Story
**As a** user,
**I want** to authenticate using Google or Facebook OAuth,
**so that** I can create polls and manage my account securely.

## Acceptance Criteria
1. Supabase Auth is configured with Google and Facebook OAuth providers
2. Login page is created with OAuth provider buttons
3. Authentication flow works end-to-end (login, logout, session management)
4. Protected routes are implemented for authenticated users
5. User profile information is displayed after authentication
6. Session persistence works across browser refreshes
7. Error handling is implemented for authentication failures

## Tasks / Subtasks
- [ ] Task 1: Configure Supabase OAuth Providers (AC: 1)
  - [ ] Set up Google OAuth provider in Supabase dashboard
  - [ ] Set up Facebook OAuth provider in Supabase dashboard
  - [ ] Configure OAuth redirect URLs
  - [ ] Test OAuth provider configuration
- [ ] Task 2: Create Authentication Context and Hooks (AC: 3, 6)
  - [ ] Implement AuthProvider component with React Context
  - [ ] Create useAuth hook for authentication state
  - [ ] Implement session management and persistence
  - [ ] Add auth state change listeners
- [ ] Task 3: Build Login Page and Components (AC: 2)
  - [ ] Create login page with OAuth provider buttons
  - [ ] Implement Google OAuth button component
  - [ ] Implement Facebook OAuth button component
  - [ ] Add loading states and error handling
- [ ] Task 4: Implement Route Protection (AC: 4)
  - [ ] Create Next.js middleware for route protection
  - [ ] Configure protected route patterns
  - [ ] Implement redirect logic for unauthenticated users
  - [ ] Add redirect logic for authenticated users on auth pages
- [ ] Task 5: Create OAuth Callback Handler (AC: 3)
  - [ ] Implement OAuth callback API route
  - [ ] Handle OAuth response and session creation
  - [ ] Implement redirect after successful authentication
  - [ ] Add error handling for OAuth failures
- [ ] Task 6: Add User Profile Display (AC: 5)
  - [ ] Create user profile component
  - [ ] Display user information after authentication
  - [ ] Implement logout functionality
  - [ ] Add user avatar and basic profile data
- [ ] Task 7: Testing (AC: All)
  - [ ] Test OAuth provider configuration
  - [ ] Test authentication flow end-to-end
  - [ ] Test route protection and redirects
  - [ ] Test session persistence
  - [ ] Test error handling scenarios

## Dev Notes

### Previous Story Insights
This story builds on Story 1.2 (Supabase Integration) which established the database connection and Supabase client configuration. The authentication system will use the Supabase client and database schema from the previous story.

### Technology Stack
[Source: architecture.md#tech-stack]
- **Authentication**: Supabase Auth with OAuth providers (Google, Facebook)
- **Session Management**: JWT tokens with automatic refresh
- **Route Protection**: Next.js middleware with Supabase auth helpers
- **State Management**: React Context for global auth state
- **OAuth Providers**: Google OAuth 2.0, Facebook Login

### Authentication Architecture
[Source: architecture.md#state-structure]

#### Auth Context Implementation
```typescript
// contexts/AuthContext.tsx
import { createContext, useContext, useEffect, useState } from 'react';
import { User, Session } from '@supabase/supabase-js';
import { supabase } from '@/lib/supabase/client';

interface AuthContextType {
  user: User | null;
  session: Session | null;
  loading: boolean;
  signIn: (provider: 'google' | 'facebook') => Promise<void>;
  signOut: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, []);

  const signIn = async (provider: 'google' | 'facebook') => {
    await supabase.auth.signInWithOAuth({ provider });
  };

  const signOut = async () => {
    await supabase.auth.signOut();
  };

  return (
    <AuthContext.Provider value={{ user, session, loading, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
```

### Route Protection
[Source: architecture.md#middleware]

#### Next.js Middleware Implementation
```typescript
// middleware.ts - Next.js middleware for auth protection
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  // Protect routes that require authentication
  if (!session && req.nextUrl.pathname.startsWith('/poll/create')) {
    return NextResponse.redirect(new URL('/login', req.url));
  }

  // Redirect authenticated users away from auth pages
  if (session && req.nextUrl.pathname.startsWith('/login')) {
    return NextResponse.redirect(new URL('/', req.url));
  }

  return res;
}

export const config = {
  matcher: ['/poll/create', '/profile', '/login', '/signup'],
};
```

### File Structure
[Source: architecture.md#route-organization]
```
src/app/
├── (auth)/                    # Auth routes (no nav)
│   ├── login/page.tsx        # /login
│   └── signup/page.tsx       # /signup
├── (main)/                    # Main app routes (with nav)
│   ├── layout.tsx            # Main layout wrapper
│   ├── page.tsx              # / (home/feed)
│   ├── poll/
│   │   ├── [id]/page.tsx    # /poll/[id]
│   │   └── create/page.tsx  # /poll/create
│   └── profile/page.tsx     # /profile
└── api/                       # API routes
    └── auth/
        └── callback/route.ts # OAuth callback
```

### OAuth Configuration
[Source: technical-specifications.md#auth-context]

#### OAuth Provider Setup
- **Google OAuth**: Configure in Supabase dashboard with Google Cloud Console
- **Facebook OAuth**: Configure in Supabase dashboard with Facebook Developer Console
- **Redirect URLs**: Set to `https://your-domain.com/api/auth/callback`
- **Scopes**: Basic profile information (email, name, picture)

#### OAuth Callback Handler
```typescript
// app/api/auth/callback/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url);
  const code = requestUrl.searchParams.get('code');

  if (code) {
    const cookieStore = cookies();
    const supabase = createRouteHandlerClient({ cookies: () => cookieStore });
    await supabase.auth.exchangeCodeForSession(code);
  }

  // Redirect to home page after successful authentication
  return NextResponse.redirect(new URL('/', requestUrl.origin));
}
```

### Component Specifications
[Source: architecture.md#frontend-components]

#### Login Page Component
- **OAuth Provider Buttons**: Google and Facebook login buttons
- **Loading States**: Show loading during authentication
- **Error Handling**: Display authentication errors
- **Responsive Design**: Mobile-first design with Tailwind CSS
- **Accessibility**: WCAG AA compliant with proper ARIA labels

#### User Profile Component
- **User Information**: Display name, email, and avatar
- **Logout Button**: Clear session and redirect to login
- **Profile Data**: Show user's poll creation history
- **Responsive Layout**: Mobile-optimized profile view

### File Locations
[Source: architecture.md#unified-project-structure]
- **Auth Context**: `apps/web/src/contexts/AuthContext.tsx`
- **Login Page**: `apps/web/src/app/(auth)/login/page.tsx`
- **Middleware**: `apps/web/middleware.ts`
- **OAuth Callback**: `apps/web/src/app/api/auth/callback/route.ts`
- **Profile Page**: `apps/web/src/app/(main)/profile/page.tsx`
- **Auth Components**: `apps/web/src/components/auth/`

### Technical Constraints
[Source: architecture.md#technical-assumptions]
- **OAuth Providers**: Google and Facebook OAuth 2.0 only
- **Session Management**: JWT tokens with automatic refresh
- **Route Protection**: Middleware-based protection for sensitive routes
- **Error Handling**: Graceful handling of OAuth failures and network issues
- **Security**: All authentication handled through Supabase Auth
- **Performance**: Optimistic UI updates for better perceived performance

### Testing
[Source: architecture.md#testing-strategy]

#### Testing Standards
- **Test File Location**: `apps/web/tests/unit/` for unit tests
- **Testing Framework**: Vitest + React Testing Library for component testing
- **Test Standards**: 
  - Unit tests for auth context and hooks
  - Integration tests for OAuth flow
  - E2E tests for complete authentication journey
- **Testing Requirements for this Story**:
  - Test OAuth provider configuration
  - Test authentication context and state management
  - Test route protection middleware
  - Test OAuth callback handling
  - Test session persistence across refreshes
  - Test error handling scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation using BMAD workflow | Product Manager |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
