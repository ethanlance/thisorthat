# Story 2.4: Poll Management Interface

## Status
Ready for Review

## Story
**As a** user,
**I want** to view and manage my created polls,
**so that** I can track their status and results.

## Acceptance Criteria
1. User dashboard displays all created polls
2. Poll status is clearly indicated (active, closed, expired)
3. Poll results are displayed with vote counts
4. Poll sharing options are available for each poll
5. Poll deletion functionality is implemented
6. Mobile-responsive layout for poll management
7. Real-time updates when poll status changes

## Tasks / Subtasks
- [x] Task 1: User Dashboard Layout (AC: 1, 6)
  - [x] Create user dashboard page with poll list
  - [x] Implement mobile-responsive grid layout
  - [x] Add navigation and filtering options
  - [x] Design poll card components for dashboard
- [x] Task 2: Poll Status Display (AC: 2, 3)
  - [x] Create poll status indicators and badges
  - [x] Display vote counts and results
  - [x] Show poll expiration information
  - [x] Implement poll statistics display
- [x] Task 3: Poll Actions (AC: 4, 5)
  - [x] Add sharing options for each poll
  - [x] Implement poll deletion functionality
  - [x] Create poll action menus
  - [x] Add confirmation dialogs for destructive actions
- [x] Task 4: Real-time Updates (AC: 7)
  - [x] Implement real-time poll status updates
  - [x] Add live vote count updates
  - [x] Handle poll expiration notifications
  - [x] Update UI when poll status changes
- [x] Task 5: Testing (AC: All)
  - [x] Test dashboard layout and responsiveness
  - [x] Test poll status display and updates
  - [x] Test poll actions and sharing
  - [x] Test real-time functionality

## Dev Notes

### Previous Story Insights
This story builds on Story 2.3 (Poll Expiration System) which established poll status tracking and expiration functionality. The management interface will provide users with a comprehensive view of their polls and enable them to manage their content effectively.

### Technology Stack
[Source: architecture.md#tech-stack]
- **Database**: Supabase with existing polls and votes tables
- **Real-time**: Supabase Realtime for live updates
- **UI Components**: Shadcn/ui components for dashboard layout
- **Mobile Design**: Tailwind CSS with mobile-first approach
- **Authentication**: Supabase Auth for user-specific data

### Integration Points
[Source: architecture.md#unified-project-structure]
- **Database**: Queries existing polls table with user filtering
- **Authentication**: Uses AuthContext from Story 1.3 for user identification
- **Poll Status**: Integrates with status system from Story 2.3
- **UI Components**: Uses existing components from Story 1.4
- **Real-time Updates**: Leverages Supabase Realtime for live data

### File Structure
[Source: architecture.md#unified-project-structure]
```
src/
├── components/
│   ├── poll/
│   │   ├── PollCard.tsx
│   │   ├── PollStatusBadge.tsx
│   │   ├── PollActions.tsx
│   │   └── PollStats.tsx
│   └── dashboard/
│       ├── UserDashboard.tsx
│       └── PollList.tsx
├── lib/
│   ├── services/
│   │   ├── polls.ts (existing, updated)
│   │   └── dashboard.ts
│   └── hooks/
│       └── useUserPolls.ts
└── app/
    └── (main)/
        └── dashboard/
            └── page.tsx
```

### Technical Implementation
[Source: technical-specifications.md#poll-management-interface]

#### User Dashboard Component
```typescript
// components/dashboard/UserDashboard.tsx
export default function UserDashboard() {
  const { user } = useAuth();
  const { polls, loading, error } = useUserPolls(user?.id);
  
  return (
    <div className="container mx-auto px-4 py-6">
      <h1 className="text-2xl font-bold mb-6">My Polls</h1>
      
      {loading && <LoadingSpinner />}
      {error && <ErrorDisplay error={error} />}
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {polls?.map((poll) => (
          <PollCard key={poll.id} poll={poll} />
        ))}
      </div>
    </div>
  );
}
```

#### Poll Card Component
```typescript
// components/poll/PollCard.tsx
interface PollCardProps {
  poll: Poll;
  onDelete?: (pollId: string) => void;
  onShare?: (pollId: string) => void;
}

export default function PollCard({ poll, onDelete, onShare }: PollCardProps) {
  const pollStatus = getPollStatus(poll);
  const timeLeft = getTimeLeft(poll.expires_at);
  
  return (
    <Card className="p-4">
      <div className="flex justify-between items-start mb-2">
        <PollStatusBadge status={pollStatus} />
        <PollActions poll={poll} onDelete={onDelete} onShare={onShare} />
      </div>
      
      <div className="grid grid-cols-2 gap-2 mb-3">
        <div className="text-center">
          <img src={poll.image_a_url} alt={poll.label_a} className="w-full h-24 object-cover rounded" />
          <p className="text-sm font-medium">{poll.label_a}</p>
        </div>
        <div className="text-center">
          <img src={poll.image_b_url} alt={poll.label_b} className="w-full h-24 object-cover rounded" />
          <p className="text-sm font-medium">{poll.label_b}</p>
        </div>
      </div>
      
      <PollStats poll={poll} />
      
      {pollStatus === 'active' && timeLeft && (
        <CountdownTimer expiresAt={poll.expires_at} />
      )}
    </Card>
  );
}
```

#### User Polls Hook
```typescript
// lib/hooks/useUserPolls.ts
export const useUserPolls = (userId: string | undefined) => {
  const [polls, setPolls] = useState<Poll[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  useEffect(() => {
    if (!userId) return;
    
    const fetchUserPolls = async () => {
      try {
        setLoading(true);
        const userPolls = await getUserPolls(userId);
        setPolls(userPolls);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Failed to fetch polls');
      } finally {
        setLoading(false);
      }
    };
    
    fetchUserPolls();
  }, [userId]);
  
  // Real-time subscription for live updates
  useEffect(() => {
    if (!userId) return;
    
    const supabase = createClient();
    const subscription = supabase
      .channel('user-polls')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'polls',
        filter: `creator_id=eq.${userId}`
      }, (payload) => {
        // Handle real-time updates
        handlePollUpdate(payload, setPolls);
      })
      .subscribe();
      
    return () => {
      subscription.unsubscribe();
    };
  }, [userId]);
  
  return { polls, loading, error };
};
```

#### Poll Actions Component
```typescript
// components/poll/PollActions.tsx
interface PollActionsProps {
  poll: Poll;
  onDelete?: (pollId: string) => void;
  onShare?: (pollId: string) => void;
}

export default function PollActions({ poll, onDelete, onShare }: PollActionsProps) {
  const [showMenu, setShowMenu] = useState(false);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  
  const handleShare = async () => {
    const pollUrl = `${window.location.origin}/poll/${poll.id}`;
    await navigator.clipboard.writeText(pollUrl);
    onShare?.(poll.id);
  };
  
  const handleDelete = async () => {
    try {
      await deletePoll(poll.id);
      onDelete?.(poll.id);
    } catch (error) {
      console.error('Failed to delete poll:', error);
    }
  };
  
  return (
    <div className="relative">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowMenu(!showMenu)}
        aria-label="Poll actions"
      >
        <MoreHorizontal className="h-4 w-4" />
      </Button>
      
      {showMenu && (
        <div className="absolute right-0 top-8 bg-white border rounded-md shadow-lg z-10">
          <button
            onClick={handleShare}
            className="w-full px-3 py-2 text-left hover:bg-gray-100"
          >
            Share
          </button>
          <button
            onClick={() => setShowDeleteDialog(true)}
            className="w-full px-3 py-2 text-left hover:bg-gray-100 text-red-600"
          >
            Delete
          </button>
        </div>
      )}
      
      {showDeleteDialog && (
        <DeleteConfirmationDialog
          onConfirm={handleDelete}
          onCancel={() => setShowDeleteDialog(false)}
        />
      )}
    </div>
  );
}
```

### File Locations
[Source: architecture.md#unified-project-structure]
- **Dashboard Components**: `apps/web/src/components/dashboard/`
- **Poll Components**: `apps/web/src/components/poll/`
- **User Dashboard Page**: `apps/web/src/app/(main)/dashboard/page.tsx`
- **Dashboard Services**: `apps/web/src/lib/services/dashboard.ts`

### Technical Constraints
[Source: architecture.md#technical-assumptions]
- **User Authentication**: Must be authenticated to access dashboard
- **Real-time Updates**: Live updates for poll status and vote counts
- **Mobile Optimization**: Responsive grid layout for mobile devices
- **Performance**: Efficient queries for user-specific poll data
- **Data Security**: Row-level security for user data access
- **Accessibility**: WCAG AA compliance for dashboard interface

### Testing
[Source: architecture.md#testing-strategy]

#### Testing Standards
- **Test File Location**: `apps/web/tests/unit/` for unit tests
- **Testing Framework**: Vitest + React Testing Library for component testing
- **Test Standards**: 
  - Unit tests for dashboard components
  - Integration tests for user poll queries
  - E2E tests for complete dashboard functionality
- **Testing Requirements for this Story**:
  - Test dashboard layout and responsiveness
  - Test poll status display and updates
  - Test poll actions and sharing functionality
  - Test real-time updates and data synchronization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation using BMAD workflow | Product Manager |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- None - all tests passing for Story 2.4 components

### Completion Notes List
1. **Dashboard Layout Implementation** (2025-10-22)
   - Created dashboard page at apps/web/src/app/(main)/dashboard/page.tsx
   - Implemented UserDashboard.tsx component with mobile-responsive grid
   - Created PollList.tsx for poll listing functionality
   - Mobile-optimized grid layout adapts from 1 to 3 columns
   - Navigation integrated with main app layout

2. **Poll Card Components** (2025-10-22)
   - Implemented PollCard.tsx with comprehensive poll display
   - Shows poll images, labels, and descriptions
   - Displays vote counts and status badges
   - Includes countdown timer for active polls
   - Mobile-friendly card design with proper spacing

3. **Poll Actions Implementation** (2025-10-22)
   - Created PollActions.tsx with action menu dropdown
   - Implemented sharing functionality via PollShare.tsx
   - Added poll deletion with confirmation dialog
   - Action menu includes share and delete options
   - Proper error handling for all actions

4. **Real-time Updates** (2025-10-22)
   - Implemented useUserPolls.ts hook with Supabase Realtime
   - Live updates when polls are created, updated, or deleted
   - Real-time vote count synchronization
   - Automatic status updates when polls expire
   - Connection status monitoring

5. **Dashboard Services** (2025-10-22)
   - Created dashboard.ts service with user-specific queries
   - Implemented getUserPolls(), getUserStats(), and filterPolls()
   - Poll statistics include active/closed counts
   - Efficient queries with proper filtering
   - All Story 2.4 integration tests passing

### File List

**New Files:**
- `apps/web/src/app/(main)/dashboard/page.tsx` - User dashboard page
- `apps/web/src/components/dashboard/UserDashboard.tsx` - Dashboard layout component
- `apps/web/src/components/dashboard/PollList.tsx` - Poll listing component
- `apps/web/src/components/poll/PollCard.tsx` - Poll card display component
- `apps/web/src/components/poll/PollActions.tsx` - Poll action menu component
- `apps/web/src/lib/hooks/useUserPolls.ts` - Real-time user polls hook
- `apps/web/src/lib/services/dashboard.ts` - Dashboard service functions
- `apps/web/tests/integration/dashboard.test.tsx` - Integration tests for dashboard

**Modified Files:**
- `apps/web/src/lib/services/polls.ts` - Added getUserPolls() and deletePoll() methods
- `apps/web/src/components/layout/Header.tsx` - Added dashboard navigation link

**Database Migrations:**
- None (uses existing polls table with creator_id filtering)

## QA Results
*This section will be populated by the QA agent after implementation review*
