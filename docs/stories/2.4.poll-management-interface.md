# Story 2.4: Poll Management Interface

## Status
Ready for Development

## Story
**As a** user,
**I want** to view and manage my created polls,
**so that** I can track their status and results.

## Acceptance Criteria
1. User dashboard displays all created polls
2. Poll status is clearly indicated (active, closed, expired)
3. Poll results are displayed with vote counts
4. Poll sharing options are available for each poll
5. Poll deletion functionality is implemented
6. Mobile-responsive layout for poll management
7. Real-time updates when poll status changes

## Tasks / Subtasks
- [ ] Task 1: User Dashboard Layout (AC: 1, 6)
  - [ ] Create user dashboard page with poll list
  - [ ] Implement mobile-responsive grid layout
  - [ ] Add navigation and filtering options
  - [ ] Design poll card components for dashboard
- [ ] Task 2: Poll Status Display (AC: 2, 3)
  - [ ] Create poll status indicators and badges
  - [ ] Display vote counts and results
  - [ ] Show poll expiration information
  - [ ] Implement poll statistics display
- [ ] Task 3: Poll Actions (AC: 4, 5)
  - [ ] Add sharing options for each poll
  - [ ] Implement poll deletion functionality
  - [ ] Create poll action menus
  - [ ] Add confirmation dialogs for destructive actions
- [ ] Task 4: Real-time Updates (AC: 7)
  - [ ] Implement real-time poll status updates
  - [ ] Add live vote count updates
  - [ ] Handle poll expiration notifications
  - [ ] Update UI when poll status changes
- [ ] Task 5: Testing (AC: All)
  - [ ] Test dashboard layout and responsiveness
  - [ ] Test poll status display and updates
  - [ ] Test poll actions and sharing
  - [ ] Test real-time functionality

## Dev Notes

### Previous Story Insights
This story builds on Story 2.3 (Poll Expiration System) which established poll status tracking and expiration functionality. The management interface will provide users with a comprehensive view of their polls and enable them to manage their content effectively.

### Technology Stack
[Source: architecture.md#tech-stack]
- **Database**: Supabase with existing polls and votes tables
- **Real-time**: Supabase Realtime for live updates
- **UI Components**: Shadcn/ui components for dashboard layout
- **Mobile Design**: Tailwind CSS with mobile-first approach
- **Authentication**: Supabase Auth for user-specific data

### Integration Points
[Source: architecture.md#unified-project-structure]
- **Database**: Queries existing polls table with user filtering
- **Authentication**: Uses AuthContext from Story 1.3 for user identification
- **Poll Status**: Integrates with status system from Story 2.3
- **UI Components**: Uses existing components from Story 1.4
- **Real-time Updates**: Leverages Supabase Realtime for live data

### File Structure
[Source: architecture.md#unified-project-structure]
```
src/
├── components/
│   ├── poll/
│   │   ├── PollCard.tsx
│   │   ├── PollStatusBadge.tsx
│   │   ├── PollActions.tsx
│   │   └── PollStats.tsx
│   └── dashboard/
│       ├── UserDashboard.tsx
│       └── PollList.tsx
├── lib/
│   ├── services/
│   │   ├── polls.ts (existing, updated)
│   │   └── dashboard.ts
│   └── hooks/
│       └── useUserPolls.ts
└── app/
    └── (main)/
        └── dashboard/
            └── page.tsx
```

### Technical Implementation
[Source: technical-specifications.md#poll-management-interface]

#### User Dashboard Component
```typescript
// components/dashboard/UserDashboard.tsx
export default function UserDashboard() {
  const { user } = useAuth();
  const { polls, loading, error } = useUserPolls(user?.id);
  
  return (
    <div className="container mx-auto px-4 py-6">
      <h1 className="text-2xl font-bold mb-6">My Polls</h1>
      
      {loading && <LoadingSpinner />}
      {error && <ErrorDisplay error={error} />}
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {polls?.map((poll) => (
          <PollCard key={poll.id} poll={poll} />
        ))}
      </div>
    </div>
  );
}
```

#### Poll Card Component
```typescript
// components/poll/PollCard.tsx
interface PollCardProps {
  poll: Poll;
  onDelete?: (pollId: string) => void;
  onShare?: (pollId: string) => void;
}

export default function PollCard({ poll, onDelete, onShare }: PollCardProps) {
  const pollStatus = getPollStatus(poll);
  const timeLeft = getTimeLeft(poll.expires_at);
  
  return (
    <Card className="p-4">
      <div className="flex justify-between items-start mb-2">
        <PollStatusBadge status={pollStatus} />
        <PollActions poll={poll} onDelete={onDelete} onShare={onShare} />
      </div>
      
      <div className="grid grid-cols-2 gap-2 mb-3">
        <div className="text-center">
          <img src={poll.image_a_url} alt={poll.label_a} className="w-full h-24 object-cover rounded" />
          <p className="text-sm font-medium">{poll.label_a}</p>
        </div>
        <div className="text-center">
          <img src={poll.image_b_url} alt={poll.label_b} className="w-full h-24 object-cover rounded" />
          <p className="text-sm font-medium">{poll.label_b}</p>
        </div>
      </div>
      
      <PollStats poll={poll} />
      
      {pollStatus === 'active' && timeLeft && (
        <CountdownTimer expiresAt={poll.expires_at} />
      )}
    </Card>
  );
}
```

#### User Polls Hook
```typescript
// lib/hooks/useUserPolls.ts
export const useUserPolls = (userId: string | undefined) => {
  const [polls, setPolls] = useState<Poll[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  useEffect(() => {
    if (!userId) return;
    
    const fetchUserPolls = async () => {
      try {
        setLoading(true);
        const userPolls = await getUserPolls(userId);
        setPolls(userPolls);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Failed to fetch polls');
      } finally {
        setLoading(false);
      }
    };
    
    fetchUserPolls();
  }, [userId]);
  
  // Real-time subscription for live updates
  useEffect(() => {
    if (!userId) return;
    
    const supabase = createClient();
    const subscription = supabase
      .channel('user-polls')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'polls',
        filter: `creator_id=eq.${userId}`
      }, (payload) => {
        // Handle real-time updates
        handlePollUpdate(payload, setPolls);
      })
      .subscribe();
      
    return () => {
      subscription.unsubscribe();
    };
  }, [userId]);
  
  return { polls, loading, error };
};
```

#### Poll Actions Component
```typescript
// components/poll/PollActions.tsx
interface PollActionsProps {
  poll: Poll;
  onDelete?: (pollId: string) => void;
  onShare?: (pollId: string) => void;
}

export default function PollActions({ poll, onDelete, onShare }: PollActionsProps) {
  const [showMenu, setShowMenu] = useState(false);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  
  const handleShare = async () => {
    const pollUrl = `${window.location.origin}/poll/${poll.id}`;
    await navigator.clipboard.writeText(pollUrl);
    onShare?.(poll.id);
  };
  
  const handleDelete = async () => {
    try {
      await deletePoll(poll.id);
      onDelete?.(poll.id);
    } catch (error) {
      console.error('Failed to delete poll:', error);
    }
  };
  
  return (
    <div className="relative">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowMenu(!showMenu)}
        aria-label="Poll actions"
      >
        <MoreHorizontal className="h-4 w-4" />
      </Button>
      
      {showMenu && (
        <div className="absolute right-0 top-8 bg-white border rounded-md shadow-lg z-10">
          <button
            onClick={handleShare}
            className="w-full px-3 py-2 text-left hover:bg-gray-100"
          >
            Share
          </button>
          <button
            onClick={() => setShowDeleteDialog(true)}
            className="w-full px-3 py-2 text-left hover:bg-gray-100 text-red-600"
          >
            Delete
          </button>
        </div>
      )}
      
      {showDeleteDialog && (
        <DeleteConfirmationDialog
          onConfirm={handleDelete}
          onCancel={() => setShowDeleteDialog(false)}
        />
      )}
    </div>
  );
}
```

### File Locations
[Source: architecture.md#unified-project-structure]
- **Dashboard Components**: `apps/web/src/components/dashboard/`
- **Poll Components**: `apps/web/src/components/poll/`
- **User Dashboard Page**: `apps/web/src/app/(main)/dashboard/page.tsx`
- **Dashboard Services**: `apps/web/src/lib/services/dashboard.ts`

### Technical Constraints
[Source: architecture.md#technical-assumptions]
- **User Authentication**: Must be authenticated to access dashboard
- **Real-time Updates**: Live updates for poll status and vote counts
- **Mobile Optimization**: Responsive grid layout for mobile devices
- **Performance**: Efficient queries for user-specific poll data
- **Data Security**: Row-level security for user data access
- **Accessibility**: WCAG AA compliance for dashboard interface

### Testing
[Source: architecture.md#testing-strategy]

#### Testing Standards
- **Test File Location**: `apps/web/tests/unit/` for unit tests
- **Testing Framework**: Vitest + React Testing Library for component testing
- **Test Standards**: 
  - Unit tests for dashboard components
  - Integration tests for user poll queries
  - E2E tests for complete dashboard functionality
- **Testing Requirements for this Story**:
  - Test dashboard layout and responsiveness
  - Test poll status display and updates
  - Test poll actions and sharing functionality
  - Test real-time updates and data synchronization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation using BMAD workflow | Product Manager |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent*

### Debug Log References
*To be populated by Dev Agent*

### Completion Notes List
*To be populated by Dev Agent*

### File List

**New Files:**
*To be populated by Dev Agent*

**Modified Files:**
*To be populated by Dev Agent*

**Database Migrations:**
*To be populated by Dev Agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
