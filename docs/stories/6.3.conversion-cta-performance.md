# Story 6.3: Conversion CTA & Performance Optimization

## User Story

As a **user who just voted on the homepage demo poll**,
I want **a clear, prominent call-to-action to create my own poll**,
So that **I'm motivated to become a creator after experiencing the product value**.

## User Story

As a **mobile user on a slower connection**,
I want **the homepage to load quickly and feel instant**,
So that **I don't abandon the site before seeing the demo poll**.

## Story Context

**Existing System Integration:**
- Integrates with: Homepage from Story 6.1, design system from Story 6.2, existing navigation
- Technology: Next.js 14+ with App Router, Vercel Edge Network, React Server/Client Components
- Follows pattern: Existing navigation patterns, API route optimization
- Touch points: Homepage, header navigation, image optimization, bundle analysis

## Acceptance Criteria

**Functional Requirements:**

1. **"Create Your Own" Primary CTA**
   - Large, prominent button appears after user votes and sees results
   - Text: "Create Your Own Poll" with emoji icon (âœ¨ or âž•)
   - Discord purple background (#5865F2), full-width on mobile
   - Desktop: 64px height, mobile: 56px height
   - Positioned prominently above results, impossible to miss
   - Includes subtle pulse animation after 5-second delay (if no interaction)

2. **Secondary "Browse Polls" Action**
   - Ghost button style (outline, no background)
   - Positioned below primary CTA, less prominent
   - Text: "Browse More Polls"
   - Links to `/polls` page
   - Mobile: 48px height, desktop: 48px height

3. **Simplified Navigation**
   - Header navigation reduced from 3-4 items to essential items only
   - Desktop: Logo | Browse | Create (primary button) | Login/Profile
   - Mobile: Logo | Hamburger (Browse, About, Login/Profile)
   - Bottom action bar (mobile only): Browse ðŸ‘€ | Create âž• (large, center) | Profile ðŸ‘¤
   - Remove redundant CTAs from old homepage layout

4. **Conversion Funnel Tracking**
   - Analytics events track key conversion points:
     - `homepage_demo_poll_view` - User lands on homepage
     - `homepage_demo_vote` - User votes on demo poll
     - `homepage_view_results` - User sees results
     - `homepage_cta_click` - User clicks "Create Your Own"
     - `homepage_browse_click` - User clicks "Browse Polls"
   - Track conversion rate: votes â†’ CTA clicks (target: 30%+)

**Performance Requirements:**

5. **First Contentful Paint (FCP)**
   - Mobile 3G: <1.5 seconds
   - Mobile 4G: <1.0 second
   - Desktop: <0.8 seconds
   - Measured via Lighthouse CI in deployment pipeline

6. **Time to Interactive (TTI)**
   - Mobile 3G: <3.5 seconds
   - Mobile 4G: <2.0 seconds
   - Desktop: <1.5 seconds
   - User can vote immediately after page loads

7. **Bundle Size Optimization**
   - Initial JavaScript bundle: <150KB gzipped
   - Route-based code splitting for non-critical components
   - Confetti library lazy loaded (not in initial bundle)
   - Tree shaking removes unused dependencies

8. **Image Optimization**
   - Poll images served as WebP with JPEG fallback
   - Responsive images via `srcset` (mobile/tablet/desktop sizes)
   - Blur-up LQIP (Low Quality Image Placeholder) while loading
   - Lazy loading for off-screen images
   - Maximum 100KB per poll image (enforced)

9. **Core Web Vitals**
   - Largest Contentful Paint (LCP): <2.5s
   - First Input Delay (FID): <100ms
   - Cumulative Layout Shift (CLS): <0.1
   - All measured and tracked via Vercel Analytics

**Integration Requirements:**

10. **Existing functionality continues to work unchanged**
    - Poll creation flow at `/poll/create` unaffected
    - Browse polls page at `/polls` working
    - Authentication system functional
    - All existing routes and navigation working

11. **New functionality follows existing patterns**
    - Uses existing Button component (Shadcn/ui)
    - Follows Next.js Image optimization patterns
    - Leverages Vercel Analytics for tracking
    - Uses existing navigation component structure

12. **Mobile-first performance**
    - Progressive enhancement for larger screens
    - Critical CSS inlined in `<head>`
    - Non-critical assets deferred or lazy loaded
    - Touch interactions remain instant (<100ms)

**Quality Requirements:**

13. **Change is covered by appropriate tests**
    - Unit tests for CTA components
    - Integration tests for conversion funnel
    - E2E tests for complete user journey
    - Performance tests with Lighthouse CI

14. **Documentation is updated if needed**
    - Performance optimization guide
    - Analytics event documentation
    - Image optimization guidelines

15. **No regression in existing functionality verified**
    - Full test suite passes
    - Lighthouse scores improve or maintain
    - All existing routes work correctly
    - Navigation accessible and functional

## Technical Notes

- **Integration Approach:** 
  - Add CTA components to results view from Story 6.1
  - Simplify Header navigation component
  - Implement analytics event tracking with Vercel Analytics
  - Optimize bundle with Next.js code splitting
  - Use Next.js Image component for automatic optimization

- **Existing Pattern Reference:** 
  - Follow Button component patterns from Shadcn/ui
  - Use existing analytics patterns from Dashboard
  - Leverage Next.js Image optimization examples
  - Match navigation simplification from mobile apps

- **Key Constraints:** 
  - Performance budget: <150KB initial JS bundle
  - FCP target: <1.5s on mobile 3G (strict requirement)
  - No database changes (pure frontend optimization)
  - Must maintain WCAG AA accessibility

## Tasks / Subtasks

- [ ] **Task 1: Conversion CTA Components** (AC: 1, 2)
  - [ ] Create `ConversionCTA` component with primary/secondary actions
  - [ ] Style primary button (Discord purple, full-width mobile)
  - [ ] Add pulse animation (triggers after 5s delay)
  - [ ] Implement secondary "Browse Polls" button
  - [ ] Position CTAs prominently in results view
  - [ ] Test CTA visibility and tap targets on mobile

- [ ] **Task 2: Navigation Simplification** (AC: 3)
  - [ ] Update `Header` component with reduced nav items
  - [ ] Implement bottom action bar for mobile
  - [ ] Remove redundant CTAs from old layout
  - [ ] Test navigation across mobile/tablet/desktop
  - [ ] Verify keyboard navigation still works
  - [ ] Test hamburger menu functionality

- [ ] **Task 3: Analytics Event Tracking** (AC: 4)
  - [ ] Install and configure Vercel Analytics
  - [ ] Add event tracking for demo poll view
  - [ ] Track vote submission events
  - [ ] Track results view events
  - [ ] Track CTA click events (create vs browse)
  - [ ] Set up conversion funnel dashboard
  - [ ] Test events fire correctly in production

- [ ] **Task 4: Bundle Size Optimization** (AC: 7)
  - [ ] Analyze bundle with `@next/bundle-analyzer`
  - [ ] Implement route-based code splitting
  - [ ] Lazy load confetti library (dynamic import)
  - [ ] Remove unused dependencies
  - [ ] Enable tree shaking for Tailwind CSS
  - [ ] Verify bundle size <150KB gzipped
  - [ ] Test app functionality after optimization

- [ ] **Task 5: Image Optimization** (AC: 8)
  - [ ] Convert poll images to WebP format (with fallback)
  - [ ] Implement responsive images with `srcset`
  - [ ] Add blur-up LQIP placeholders
  - [ ] Configure lazy loading for off-screen images
  - [ ] Enforce 100KB max file size in upload
  - [ ] Test image loading on various connections
  - [ ] Verify image quality across devices

- [ ] **Task 6: Critical CSS Optimization** (AC: 12)
  - [ ] Inline critical CSS in `<head>`
  - [ ] Defer non-critical CSS loading
  - [ ] Purge unused Tailwind classes
  - [ ] Minimize CSS bundle size
  - [ ] Test above-fold rendering speed

- [ ] **Task 7: Lighthouse CI Integration** (AC: 5, 6, 9, 13)
  - [ ] Set up Lighthouse CI in GitHub Actions
  - [ ] Configure performance budgets
  - [ ] Run audits on each deployment
  - [ ] Block merges if scores drop below thresholds
  - [ ] Set targets: Performance 90+, Accessibility 95+
  - [ ] Monitor Core Web Vitals in production

- [ ] **Task 8: Performance Monitoring** (AC: 5, 6, 9)
  - [ ] Enable Vercel Speed Insights
  - [ ] Track Real User Monitoring (RUM) metrics
  - [ ] Set up alerts for performance degradation
  - [ ] Monitor Core Web Vitals dashboard
  - [ ] Track FCP, LCP, FID, CLS metrics
  - [ ] Analyze performance by device/connection type

- [ ] **Task 9: Testing & Quality Assurance** (AC: 13, 14, 15)
  - [ ] Write unit tests for CTA components
  - [ ] Create integration tests for conversion funnel
  - [ ] Add E2E test for complete user journey (land â†’ vote â†’ create)
  - [ ] Run full regression test suite
  - [ ] Test on actual mobile devices (3G/4G)
  - [ ] Update performance documentation

## Dev Notes

### Relevant Source Tree

```
apps/web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ page.tsx                      # UPDATE: Add CTAs to results view
â”‚   â”‚   â””â”€â”€ layout.tsx                    # UPDATE: Inline critical CSS
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ poll/
â”‚   â”‚   â”‚   â”œâ”€â”€ ConversionCTA.tsx         # CREATE: Primary/secondary CTAs
â”‚   â”‚   â”‚   â””â”€â”€ PollResults.tsx           # UPDATE: Integrate CTAs
â”‚   â”‚   â””â”€â”€ layout/
â”‚   â”‚       â”œâ”€â”€ Header.tsx                # UPDATE: Simplify navigation
â”‚   â”‚       â”œâ”€â”€ MobileNav.tsx             # UPDATE: Add bottom action bar
â”‚   â”‚       â””â”€â”€ BottomActionBar.tsx       # CREATE: Mobile nav bar
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ analytics/
â”‚       â”‚   â””â”€â”€ events.ts                 # CREATE: Analytics helpers
â”‚       â””â”€â”€ utils/
â”‚           â””â”€â”€ performance.ts            # CREATE: Performance utilities
â”œâ”€â”€ .lighthouserc.json                    # CREATE: Lighthouse CI config
â”œâ”€â”€ next.config.ts                        # UPDATE: Image optimization, bundle analysis
â””â”€â”€ package.json                          # UPDATE: Add @next/bundle-analyzer
```

### Technical Implementation Details

**Conversion CTA Component:**
```typescript
// components/poll/ConversionCTA.tsx
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { trackEvent } from '@/lib/analytics/events';
import { Plus } from 'lucide-react';

export function ConversionCTA() {
  const [showPulse, setShowPulse] = useState(false);
  
  useEffect(() => {
    // Start pulse animation after 5 seconds
    const timer = setTimeout(() => setShowPulse(true), 5000);
    return () => clearTimeout(timer);
  }, []);
  
  const handleCreateClick = () => {
    trackEvent('homepage_cta_click', { action: 'create' });
  };
  
  const handleBrowseClick = () => {
    trackEvent('homepage_cta_click', { action: 'browse' });
  };
  
  return (
    <div className="flex flex-col gap-4 w-full max-w-md mx-auto mt-8">
      <Button
        size="lg"
        className={cn(
          "w-full h-14 text-lg font-semibold",
          showPulse && "animate-pulse"
        )}
        onClick={handleCreateClick}
        asChild
      >
        <Link href="/poll/create">
          <Plus className="w-5 h-5 mr-2" />
          Create Your Own Poll
        </Link>
      </Button>
      
      <Button
        variant="outline"
        size="lg"
        className="w-full"
        onClick={handleBrowseClick}
        asChild
      >
        <Link href="/polls">
          Browse More Polls
        </Link>
      </Button>
    </div>
  );
}
```

**Analytics Event Tracking:**
```typescript
// lib/analytics/events.ts
import { track } from '@vercel/analytics';

export function trackEvent(eventName: string, properties?: Record<string, any>) {
  track(eventName, properties);
}

// Usage in components:
trackEvent('homepage_demo_poll_view');
trackEvent('homepage_demo_vote', { choice: 'option_a' });
trackEvent('homepage_view_results', { winning_option: 'option_a', margin: 15 });
trackEvent('homepage_cta_click', { action: 'create' });
```

**Next.js Image Optimization:**
```typescript
// next.config.ts
export default {
  images: {
    formats: ['image/webp', 'image/avif'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    minimumCacheTTL: 60,
  },
  webpack: (config, { isServer }) => {
    if (!isServer) {
      config.optimization.splitChunks = {
        chunks: 'all',
        cacheGroups: {
          default: false,
          vendors: false,
          // Separate vendor chunks
          vendor: {
            name: 'vendor',
            chunks: 'all',
            test: /node_modules/,
            priority: 20,
          },
          // Separate common chunks
          common: {
            name: 'common',
            minChunks: 2,
            chunks: 'all',
            priority: 10,
            reuseExistingChunk: true,
            enforce: true,
          },
        },
      };
    }
    return config;
  },
};
```

**Lighthouse CI Configuration:**
```json
// .lighthouserc.json
{
  "ci": {
    "collect": {
      "startServerCommand": "npm run build && npm run start",
      "url": ["http://localhost:3000"],
      "numberOfRuns": 3
    },
    "assert": {
      "preset": "lighthouse:recommended",
      "assertions": {
        "first-contentful-paint": ["error", {"maxNumericValue": 1500}],
        "speed-index": ["error", {"maxNumericValue": 3000}],
        "largest-contentful-paint": ["error", {"maxNumericValue": 2500}],
        "cumulative-layout-shift": ["error", {"maxNumericValue": 0.1}],
        "total-blocking-time": ["error", {"maxNumericValue": 300}],
        "categories:performance": ["error", {"minScore": 0.9}],
        "categories:accessibility": ["error", {"minScore": 0.95}]
      }
    },
    "upload": {
      "target": "temporary-public-storage"
    }
  }
}
```

**GitHub Actions Workflow:**
```yaml
# .github/workflows/lighthouse-ci.yml
name: Lighthouse CI
on: [push, pull_request]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build
      - run: npm install -g @lhci/cli
      - run: lhci autorun
```

### Testing Standards

**Test File Location:**
- Unit tests: `tests/unit/components/ConversionCTA.test.tsx`
- Integration tests: `tests/integration/conversion-funnel.test.tsx`
- E2E tests: `tests/e2e/homepage-to-create-flow.spec.ts`
- Performance tests: Lighthouse CI (automated)

**Key Test Scenarios:**
1. CTA buttons appear after vote results shown
2. Primary CTA links to `/poll/create`
3. Secondary CTA links to `/polls`
4. Pulse animation triggers after 5 seconds
5. Analytics events fire correctly
6. Navigation simplified (correct links)
7. Bottom action bar works on mobile
8. FCP <1.5s on simulated 3G
9. Bundle size <150KB gzipped
10. Core Web Vitals meet targets
11. No layout shift during page load
12. Images load progressively with blur-up

### Performance Budgets

| Metric | Target | Maximum | Current |
|--------|--------|---------|---------|
| FCP (3G) | <1.5s | 2.0s | TBD |
| TTI (3G) | <3.5s | 4.5s | TBD |
| LCP | <2.5s | 3.0s | TBD |
| CLS | <0.1 | 0.15 | TBD |
| JS Bundle | <150KB | 200KB | TBD |
| CSS Bundle | <30KB | 50KB | TBD |
| Image Size | <100KB | 150KB | TBD |

### Analytics Dashboard Metrics

**Conversion Funnel:**
1. Homepage Views (100%)
2. Demo Poll Votes (target: 80%+)
3. Results Views (target: 100% of voters)
4. CTA Clicks (target: 30%+ of voters)
5. Poll Created (target: 20%+ of CTA clicks)

**Tracking:**
- Daily active users (DAU)
- Voter-to-creator conversion rate
- Bounce rate on homepage
- Time to first vote (speed metric)
- Device/connection type distribution

## Definition of Done

- [ ] "Create Your Own" CTA prominently displayed after vote
- [ ] Secondary "Browse Polls" action available
- [ ] Navigation simplified (header and mobile)
- [ ] Analytics events tracking conversion funnel
- [ ] FCP <1.5s on mobile 3G (Lighthouse verified)
- [ ] TTI <3.5s on mobile 3G
- [ ] Initial JS bundle <150KB gzipped
- [ ] Images optimized (WebP, responsive, blur-up)
- [ ] Core Web Vitals meet targets (LCP, FID, CLS)
- [ ] Lighthouse CI integrated and passing
- [ ] All tests passing (unit, integration, E2E)
- [ ] No regressions in existing functionality
- [ ] Performance documentation updated
- [ ] Analytics dashboard configured

## Status

Approved

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story created from Epic 6 | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

