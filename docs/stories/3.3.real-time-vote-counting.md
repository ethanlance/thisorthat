# Story 3.3: Real-time Vote Counting

## Status
Ready for Development

## Story
**As Sarah (poll creator),**
I want to see vote counts update in real-time,
so that I can watch my friends' opinions come in live.

## Acceptance Criteria
1. When someone votes, I see the count update immediately
2. I can see a visual representation of the vote distribution
3. The total number of votes is displayed
4. Updates happen automatically without refreshing the page
5. I can see the percentage breakdown of votes
6. The real-time updates work on my mobile browser
7. If the connection is lost, I see a reconnection message

## Tasks / Subtasks
- [ ] Task 1: Real-time Vote Updates (AC: 1, 4, 6)
  - [ ] Implement Supabase Realtime subscriptions for vote updates
  - [ ] Create real-time vote count synchronization
  - [ ] Add automatic UI updates without page refresh
  - [ ] Ensure mobile browser compatibility
- [ ] Task 2: Visual Vote Distribution (AC: 2, 3, 5)
  - [ ] Create visual progress bars for vote distribution
  - [ ] Display total vote count prominently
  - [ ] Show percentage breakdown for each option
  - [ ] Add animated transitions for vote count changes
- [ ] Task 3: Connection Status Management (AC: 7)
  - [ ] Implement connection status monitoring
  - [ ] Add reconnection message for lost connections
  - [ ] Handle offline/online state transitions
  - [ ] Provide fallback polling for unreliable connections
- [ ] Task 4: Performance Optimization (AC: 6)
  - [ ] Optimize real-time updates for mobile performance
  - [ ] Implement efficient vote count calculations
  - [ ] Add debouncing for rapid vote updates
  - [ ] Ensure smooth animations on mobile devices
- [ ] Task 5: Testing (AC: All)
  - [ ] Test real-time vote count updates
  - [ ] Test visual vote distribution display
  - [ ] Test connection status and reconnection
  - [ ] Test mobile browser compatibility

## Dev Notes

### Previous Story Insights
This story builds on Story 3.2 (Binary Voting System) which established the voting functionality and Story 3.1 (Poll Viewing Interface) which created the poll display components. The real-time vote counting will enhance the user experience by providing live updates as votes come in.

### Technology Stack
[Source: architecture.md#tech-stack]
- **Real-time**: Supabase Realtime for live vote updates
- **UI Components**: Shadcn/ui components with animated progress bars
- **Mobile Design**: Tailwind CSS with mobile-first approach
- **Performance**: React optimization for smooth animations
- **Connection**: WebSocket management with fallback polling

### Integration Points
[Source: architecture.md#unified-project-structure]
- **Database**: Real-time subscriptions to votes table
- **Voting System**: Integrates with existing vote submission from Story 3.2
- **Poll Display**: Enhances PollResults component from Story 3.1
- **Mobile Optimization**: Ensures smooth performance on mobile devices
- **Connection Management**: Handles network reliability and reconnection

### File Structure
[Source: architecture.md#unified-project-structure]
```
src/
├── components/
│   ├── poll/
│   │   ├── PollResults.tsx (existing, updated)
│   │   ├── VoteCountDisplay.tsx
│   │   ├── ConnectionStatus.tsx
│   │   └── AnimatedProgressBar.tsx
│   └── ui/
│       └── (existing components)
├── lib/
│   ├── hooks/
│   │   ├── usePoll.ts (existing, updated)
│   │   ├── useRealtimeVotes.ts
│   │   └── useConnectionStatus.ts
│   └── utils/
│       └── realtime-helpers.ts
└── app/
    └── (main)/
        └── poll/
            └── [id]/
                └── page.tsx (existing, updated)
```

### Technical Implementation
[Source: technical-specifications.md#real-time-vote-counting]

#### Real-time Vote Hook
```typescript
// lib/hooks/useRealtimeVotes.ts
export const useRealtimeVotes = (pollId: string) => {
  const [voteCounts, setVoteCounts] = useState({ option_a: 0, option_b: 0 });
  const [isConnected, setIsConnected] = useState(true);
  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);

  useEffect(() => {
    const supabase = createClient();
    
    const subscription = supabase
      .channel('vote-updates')
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'votes',
        filter: `poll_id=eq.${pollId}`
      }, (payload) => {
        const newVote = payload.new;
        setVoteCounts(prev => ({
          option_a: newVote.choice === 'option_a' ? prev.option_a + 1 : prev.option_a,
          option_b: newVote.choice === 'option_b' ? prev.option_b + 1 : prev.option_b
        }));
        setLastUpdate(new Date());
      })
      .on('system', {}, (status) => {
        setIsConnected(status === 'SUBSCRIBED');
      })
      .subscribe();

    return () => subscription.unsubscribe();
  }, [pollId]);

  return { voteCounts, isConnected, lastUpdate };
};
```

#### Animated Progress Bar Component
```typescript
// components/poll/AnimatedProgressBar.tsx
interface AnimatedProgressBarProps {
  value: number;
  max: number;
  color: string;
  className?: string;
}

export default function AnimatedProgressBar({ 
  value, 
  max, 
  color, 
  className 
}: AnimatedProgressBarProps) {
  const percentage = max > 0 ? (value / max) * 100 : 0;
  
  return (
    <div className={cn('w-full bg-muted rounded-full h-3 overflow-hidden', className)}>
      <div
        className={cn('h-full transition-all duration-500 ease-out', color)}
        style={{ width: `${percentage}%` }}
      />
    </div>
  );
}
```

#### Vote Count Display Component
```typescript
// components/poll/VoteCountDisplay.tsx
interface VoteCountDisplayProps {
  voteCounts: { option_a: number; option_b: number };
  isConnected: boolean;
  lastUpdate: Date | null;
  className?: string;
}

export default function VoteCountDisplay({ 
  voteCounts, 
  isConnected, 
  lastUpdate,
  className 
}: VoteCountDisplayProps) {
  const totalVotes = voteCounts.option_a + voteCounts.option_b;
  const optionAPercentage = totalVotes > 0 ? Math.round((voteCounts.option_a / totalVotes) * 100) : 0;
  const optionBPercentage = totalVotes > 0 ? Math.round((voteCounts.option_b / totalVotes) * 100) : 0;

  return (
    <div className={cn('space-y-4', className)}>
      {/* Connection Status */}
      <ConnectionStatus isConnected={isConnected} lastUpdate={lastUpdate} />
      
      {/* Vote Counts */}
      <div className="text-center mb-4">
        <div className="text-2xl font-bold">{totalVotes}</div>
        <div className="text-sm text-muted-foreground">Total Votes</div>
      </div>

      {/* Option A Results */}
      <div className="space-y-2">
        <div className="flex justify-between text-sm">
          <span>Option A</span>
          <span>{voteCounts.option_a} votes ({optionAPercentage}%)</span>
        </div>
        <AnimatedProgressBar 
          value={voteCounts.option_a} 
          max={totalVotes} 
          color="bg-blue-500" 
        />
      </div>

      {/* Option B Results */}
      <div className="space-y-2">
        <div className="flex justify-between text-sm">
          <span>Option B</span>
          <span>{voteCounts.option_b} votes ({optionBPercentage}%)</span>
        </div>
        <AnimatedProgressBar 
          value={voteCounts.option_b} 
          max={totalVotes} 
          color="bg-red-500" 
        />
      </div>
    </div>
  );
}
```

#### Connection Status Component
```typescript
// components/poll/ConnectionStatus.tsx
interface ConnectionStatusProps {
  isConnected: boolean;
  lastUpdate: Date | null;
  className?: string;
}

export default function ConnectionStatus({ 
  isConnected, 
  lastUpdate,
  className 
}: ConnectionStatusProps) {
  if (isConnected) return null;

  return (
    <div className={cn('bg-yellow-50 border border-yellow-200 rounded-lg p-3', className)}>
      <div className="flex items-center gap-2">
        <div className="w-2 h-2 bg-yellow-500 rounded-full animate-pulse" />
        <span className="text-sm text-yellow-800">
          Connection lost. Attempting to reconnect...
        </span>
      </div>
      {lastUpdate && (
        <div className="text-xs text-yellow-600 mt-1">
          Last update: {lastUpdate.toLocaleTimeString()}
        </div>
      )}
    </div>
  );
}
```

### File Locations
[Source: architecture.md#unified-project-structure]
- **Real-time Vote Hook**: `apps/web/src/lib/hooks/useRealtimeVotes.ts`
- **Vote Count Display**: `apps/web/src/components/poll/VoteCountDisplay.tsx`
- **Connection Status**: `apps/web/src/components/poll/ConnectionStatus.tsx`
- **Animated Progress Bar**: `apps/web/src/components/poll/AnimatedProgressBar.tsx`

### Technical Constraints
[Source: architecture.md#technical-assumptions]
- **Real-time Performance**: Updates within 500ms of vote submission
- **Mobile Optimization**: Smooth animations on mobile devices
- **Connection Reliability**: Graceful handling of network issues
- **Performance**: Efficient vote count calculations and updates
- **Accessibility**: Screen reader support for live updates
- **Fallback**: Polling fallback for unreliable connections

### Testing
[Source: architecture.md#testing-strategy]

#### Testing Standards
- **Test File Location**: `apps/web/tests/unit/` for unit tests
- **Testing Framework**: Vitest + React Testing Library for component testing
- **Test Standards**: 
  - Unit tests for real-time vote counting logic
  - Integration tests for live vote updates
  - E2E tests for complete real-time experience
- **Testing Requirements for this Story**:
  - Test real-time vote count updates
  - Test visual vote distribution display
  - Test connection status and reconnection
  - Test mobile browser compatibility

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation using BMAD workflow | Product Manager |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent*

### Debug Log References
*To be populated by Dev Agent*

### Completion Notes List
*To be populated by Dev Agent*

### File List

**New Files:**
*To be populated by Dev Agent*

**Modified Files:**
*To be populated by Dev Agent*

**Database Migrations:**
*To be populated by Dev Agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
